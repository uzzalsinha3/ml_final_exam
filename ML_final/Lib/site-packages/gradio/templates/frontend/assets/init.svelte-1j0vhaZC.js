import*as d from"./svelte/svelte_internal_client.js";import{f as j,h as b,t as y,j as x}from"./i18n-BldJSFLV.js";import{tick as f}from"./svelte/svelte_svelte.js";import{d as R}from"./index-tFQomdd2.js";import{a as k}from"./utils.svelte-Ceck75cM.js";import"./index-Ds2meNS5.js";const L={walkthrough:"tabs",walkthroughstep:"tabitem"};class H{#s;#r;#e;reactive_formatter=r=>r;#t;client;#o=d.state();get root(){return d.get(this.#o)}set root(r){d.set(this.#o,r,!0)}root_untracked;#p=new Set;#n=new Set;#h=[];#a=new Map;#i=new Map;#l;component_ids;initial_tabs={};components_to_register=new Set;ready;ready_resolve;resolved=!1;#c=new Set;constructor(r,e,i,s,o,p,n){this.ready=new Promise(l=>{this.ready_resolve=l}),this.reactive_formatter=p,this.#t={...s,api_url:new URL(s.api_prefix,s.root).toString()},this.#s=r,this.#r=e,this.#e=i,this.root=this.create_node({id:e.id,children:[]},new Map,!0);for(const l of r)l.props.visible!=!1&&this.components_to_register.add(l.id);this.client=o,this.prepare();const a=r.reduce((l,c)=>(l.set(c.id,c),l),new Map);this.root.children=this.#r.children.map(l=>this.traverse(l,c=>this.create_node(c,a,!1,this.reactive_formatter))),this.component_ids=r.map(l=>l.id),this.initial_tabs={},v(this.root,this.initial_tabs),this.postprocess(this.root),this.#l=n,this.root_untracked=this.root}reload(r,e,i,s){this.#r=e,this.#s=r,this.#t={...s,api_url:new URL(s.api_prefix,s.root).toString()},this.#e=i,this.root=this.create_node({id:e.id,children:[]},new Map,!0);for(const p of r)p.props.visible!=!1&&this.components_to_register.add(p.id);this.prepare();const o=r.reduce((p,n)=>(p.set(n.id,n),p),new Map);this.root.children=this.#r.children.map(p=>this.traverse(p,n=>this.create_node(n,o,!1,this.reactive_formatter))),this.component_ids=r.map(p=>p.id),this.initial_tabs={},v(this.root,this.initial_tabs),this.postprocess(this.root)}register_component(r,e,i){this.#i.set(r,e),this.#a.set(r,i),this.components_to_register.delete(r),this.components_to_register.size===0&&!this.resolved&&(this.resolved=!0,this.ready_resolve())}prepare(){const[r,e]=j(this.#e);this.#p=r,this.#n=e}process(){}postprocess(r){this.root=this.traverse(r,[e=>h(e,this.#t.api_url),e=>$(e,this.components_to_register),e=>z(e,this.components_to_register),e=>B(e),e=>w(e,this.initial_tabs),e=>this.find_attached_events(e,this.#e),e=>q(e,this.components_to_register,this.#c)])}find_attached_events(r,e){const i=e.filter(s=>s.targets.find(([o])=>o===r.id)).map(s=>{const o=s.targets.find(([p])=>p===r.id);return o?o[1]:null}).filter(Boolean);return r.props.shared_props.attached_events=i,r}traverse(r,e){function i(s,o,p){const n=o(s);return"children"in s&&s.children.length>0&&(n.children=s.children?.map(a=>p(a,o))||[]),n}if(Array.isArray(e)){let s=r;for(const o of e)s=i(s,o,this.traverse.bind(this));return s}else return i(r,e,this.traverse.bind(this))}create_node(r,e,i=!1,s){let o;if(i?o={type:"column",id:r.id,props:{visible:!0,root:"",theme_mode:"light"},component_class_id:"column",key:null}:o=e.get(r.id),!o)throw new Error(`Component with ID ${r.id} not found`);s&&(o.props.i18n=s);const p=P(r.id,o.props,[this.#p,this.#n],this.client,this.#t.api_url,{...this.#t}),n=L[o.type]||o.type;return{id:r.id,type:n,props:p,children:[],show_progress_on:null,component_class_id:o.component_class_id||o.type,component:p.shared_props.visible!==!1?b(o.type,o.component_class_id,this.#t.api_url||""):null,key:o.key,rendered_in:o.rendered_in,documentation:o.documentation,original_visibility:p.shared_props.visible}}rerender(r,e){const i=r.reduce((n,a)=>(n.set(a.id,a),n),new Map),s=this.traverse(e,n=>this.create_node(n,i,!1,this.reactive_formatter));v(s,this.initial_tabs);const o=this.traverse(s,n=>w(n,this.initial_tabs)),p=_(this.root,o.id);if(!p)throw new Error("Rerender failed: root node not found in current tree");p.children=o.children}async update_visibility(r,e){r.children.forEach(i=>{const s=this.#i.get(i.id);s&&s(e),this.update_visibility(i,e)})}async update_state(r,e,i=!0){const s=_(this.root,r);let o=!1;i&&!s?.component&&(await f(),this.root=this.traverse(this.root,[a=>U(a,r,e.visible),a=>g(a,r,e.visible),a=>h(a,this.#t.api_url)]),await f(),o=!0);const p=this.#i.get(r);if(p)p&&p(e);else{const a=s?.props.props.value,l=M(e);s.props.shared_props={...s?.props.shared_props,...l.shared_props},s.props.props={...s?.props.props,...l.props},"value"in e&&!R(a,e.value)&&this.#l(r,"change",null)}if(!i||o)return;await f(),await this.update_visibility(s,e);const n=A(this.root,r);n&&g(n,r,e.visible)}async get_state(r){const e=this.#a.get(r),i=_(this.root,r);return!e&&!i?null:e?await e():i?Promise.resolve({value:i.props.props.value}):null}async render_previously_invisible_children(r){this.root=this.traverse(this.root,[e=>(e.id===r&&E(e,this.#c),e),e=>h(e,this.#t.api_url)])}}function E(t,r){t.props.shared_props.visible=r.has(t.id)?!0:t.props.shared_props.visible,t.children.forEach(e=>{E(e,r)})}function O(t,r,e){return r?r.reduce((i,s)=>(i[s]=async(...o)=>(o.length===1&&(o=o[0]),await e.component_server(t,s,o)),i),{}):{}}function M(t){const r={},e={};for(const i in t)if(i==="id"||i==="autoscroll")e[i]=t[i];else if(k.includes(i)){const s=i;r[s]=t[i]}else e[i]=t[i];return{shared_props:r,props:e}}function P(t,r,e,i,s,o={}){const{shared_props:p,props:n}=M(r);p.server=O(t,r.server_fns,i);for(const a in o)if(k.includes(a)){const l=a;p[l]=o[a]}else n[a]=o[a];return p.client=i,p.id=t,p.interactive=x(t,p.interactive,n.value,e),p.load_component=(a,l)=>b(a,"",s,l),p.visible=p.visible===void 0?!0:p.visible,p.loading_status={},{shared_props:p,props:n}}function h(t,r){if(t.props.shared_props.visible&&!t.component){const e={...t,component:b(t.type,t.component_class_id,r),children:[]};return t.children&&(e.children=t.children.map(i=>h(i,r))),e}else return t}function U(t,r,e){return t.id==r&&(t.props.shared_props.visible=e),t}function u(t,r){r.delete(t.id),t.children&&t.children.forEach(e=>u(e,r))}function $(t,r){return t.props.shared_props.visible!==!0&&u(t,r),t}function m(t,r){return t.props.shared_props.visible===!0&&(r.add(t.id),t.props.shared_props.visible=!1),t.children.forEach(e=>{m(e,r)}),t}function q(t,r,e){return t.type==="accordion"&&t.props.props.open===!1&&(u(t,r),t.children&&t.children.forEach(i=>{m(i,e)})),t.type==="tabs"&&t.children.forEach(i=>{i.type==="tabitem"&&i.props.props.id!==(t.props.props.selected||t.props.props.initial_tabs[0].id)&&(u(i,r),m(i,e))}),t}function z(t,r){return t.type==="form"&&t.children.every(i=>i.props.shared_props.visible===!1)&&(t.props.shared_props.visible=!1,r.delete(t.id)),t}function g(t,r,e){return t.type==="form"&&t.children.length&&t.children.some(i=>i.id===r)&&(e===!0?t.props.shared_props.visible=!0:!e&&t.children.length===1&&(t.props.shared_props.visible="hidden")),t}function B(t){const r=["description","info","title","placeholder","value","label"];for(const e of Object.keys(t.props.shared_props))r.includes(e)&&(t.props.shared_props[e]=y(t.props.shared_props[e]));for(const e of Object.keys(t.props.props))r.includes(e)&&(t.props.props[e]=y(t.props.props[e]));return t}function w(t,r){if(t.type==="tabs"&&t.id in r){const e=r[t.id].sort((i,s)=>i.order-s.order);t.props.props.initial_tabs=e}else t.type==="tabitem"&&(t.props.props.component_id=t.id);return t}function S(t,r,e,i){e!==null&&t.type==="tabitem"&&(e in r||(r[e]=[]),"id"in t.props.props||(t.props.props.id=t.id),r[e].push({label:t.props.shared_props.label,id:t.props.props.id,elem_id:t.props.shared_props.elem_id,visible:t.props.shared_props.visible,interactive:t.props.shared_props.interactive,scale:t.props.shared_props.scale||null,component_id:t.id}),t.props.props.order=i),t.children&&t.children.forEach((s,o)=>{S(s,r,t.type==="tabs"?t.id:null,t.type==="tabs"?o:null)})}function v(t,r){function e(i){"children"in i&&i.children.length>0&&i.children?.forEach(s=>S(s,r,i.type==="tabs"?i.id:null,null))}return e(t)}function _(t,r){if(t.id===r)return t;if(t.children)for(const e of t.children){const i=_(e,r);if(i)return i}return null}function A(t,r){if(t.children)for(const e of t.children){if(e.id===r)return t;const i=A(e,r);if(i)return i}return null}export{H as A};
